<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>排班編輯器</title>
  <style>
    body{font-family: sans-serif;max-width:800px;margin:2em auto;padding:0 1em}
    table{width:100%;border-collapse:collapse;margin-top:1em}
    th,td{border:1px solid #ccc;padding:0.5em;text-align:center}
    button{margin:0.2em}
    /* Modal */
    #dlg {
      display:none;
      position:fixed; top:10%; left:50%;
      transform:translateX(-50%);
      background:#fff;
      padding:1em;
      border:1px solid #666;
      box-shadow:2px 2px 8px rgba(0,0,0,0.3);
      width:320px;
    }
    #dlg h3 { margin-top:0 }
    #dlg label{display:block;margin:0.5em 0}
    #dlg input[type="text"],
    #dlg input[type="date"],
    #dlg select {
      width:100%; box-sizing:border-box;
    }
    #dlg select[multiple] { height:6em }
  </style>
</head>
<body>

  <h1>排班編輯器</h1>
  <button onclick="openAdd()">＋ 新增日期</button>
  <table>
    <thead>
      <tr>
        <th>日期</th><th>現場</th><th>WFH</th><th>動作</th>
      </tr>
    </thead>
    <tbody id="tb"></tbody>
  </table>

  <!-- 編輯對話窗 -->
  <div id="dlg">
    <h3 id="dlgTitle">編輯排班</h3>
    <label>
      日期：
      <input type="date" id="fDate">
    </label>
    <label>
      現場：
      <select id="fOnsite" multiple></select>
    </label>
    <label>
      WFH：
      <select id="fWfh" multiple></select>
    </label>
    <div style="text-align:right;margin-top:1em">
      <button onclick="save()">存檔</button>
      <button onclick="closeDlg()">取消</button>
    </div>
  </div>

  <script>
  let roster = [], selection = [], editDate = null;

  // 1. 啟動時同時載入 排班 與 同事名單
  Promise.all([
    fetch('/api/roster').then(r=>r.json()),
    fetch('/api/selection').then(r=>r.json())
  ]).then(([rlist,slist])=>{
    roster    = rlist;
    selection = slist;
    renderTable();
  }).catch(e=>{
    alert('載入失敗：'+e);
  });

  // 2. 把 roster render 成表格
  function renderTable(){
    const tb = document.getElementById('tb');
    tb.innerHTML = '';
    roster.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.onsite.join('、')}</td>
        <td>${r.wfh.join('、')}</td>
        <td>
          <button onclick="openEdit('${r.date}')">編輯</button>
          <button onclick="del('${r.date}')">刪除</button>
        </td>`;
      tb.appendChild(tr);
    });
  }

  // 3. 建立 <select> 選項
  function buildSelects(ons=[], wfh=[]){
    const so = document.getElementById('fOnsite');
    const sw = document.getElementById('fWfh');
    so.innerHTML = sw.innerHTML = '';
    selection.forEach(name=>{
      const o1 = new Option(name,name);
      const o2 = new Option(name,name);
      if(ons.includes(name)) o1.selected = true;
      if(wfh.includes(name)) o2.selected = true;
      so.add(o1);
      sw.add(o2);
    });
  }

  // 4. 開「新增」對話窗
  function openAdd(){
    editDate = null;
    document.getElementById('dlgTitle').innerText = '新增排班';
    document.getElementById('fDate').value = '';
    buildSelects();
    showDlg();
  }

  // 5. 開「編輯」對話窗
  function openEdit(date){
    editDate = date;
    const r = roster.find(x=>x.date===date);
    document.getElementById('dlgTitle').innerText = '編輯排班';
    document.getElementById('fDate').value = r.date;
    buildSelects(r.onsite, r.wfh);
    showDlg();
  }

  function showDlg(){
    document.getElementById('dlg').style.display = 'block';
  }
  function closeDlg(){
    document.getElementById('dlg').style.display = 'none';
  }

  function getSelected(id){
    return Array.from(document.getElementById(id).selectedOptions)
                .map(o=>o.value);
  }

  // 6. 按存檔 → POST or PUT
  function save(){
    const date = document.getElementById('fDate').value;
    if(!date) return alert('請填日期');
    const onsite = getSelected('fOnsite');
    const wfh    = getSelected('fWfh');
    const body = JSON.stringify({date, onsite, wfh});
    const hdr  = {'Content-Type':'application/json'};
    let url    = '/api/roster';
    let opt    = {method:'POST', headers:hdr, body};

    if(editDate){
      url = `/api/roster/${editDate}`;
      opt.method = 'PUT';
    }

    fetch(url, opt)
      .then(r=>r.json())
      .then(j=>{
        if(j.error) alert(j.error);
        else location.reload();
      });
  }

  // 7. 刪除
  function del(d){
    if(!confirm(`確定刪除 ${d}?`)) return;
    fetch(`/api/roster/${d}`, {method:'DELETE'})
      .then(_=>location.reload());
  }
  </script>
</body>
</html>
