<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Roster + 閱讀名單 編輯器 (純前端)</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1, h2 { margin-top: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
    input, button, textarea { font-size: 1rem; }
    .center { text-align: center; }
    textarea { width: 100%; box-sizing: border-box; }
  </style>
  <!-- ical.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
</head>
<body>
  <h1>Roster ICS 編輯器 (純前端)</h1>
  <p>從 <code>roster.ics</code> 讀取事件，可直接修改並「下載」新檔。</p>
  <div id="status-ics">載入 ICS 中…</div>
  <form id="editor-ics" style="display:none">
    <table>
      <thead>
        <tr>
          <th class="center">#</th>
          <th>日期 (UTC)</th>
          <th>事件名稱 (SUMMARY)</th>
          <th>地點 (LOCATION)</th>
        </tr>
      </thead>
      <tbody id="events-tbody"></tbody>
    </table>
    <button type="button" id="download-ics">下載 ICS</button>
  </form>

  <h2>閱讀名單 編輯器 (selection.txt)</h2>
  <p>從 <code>selection.txt</code> 讀取閱讀名單，可直接修改並「下載」新檔。</p>
  <div id="status-txt">載入閱讀名單中…</div>
  <form id="editor-txt" style="display:none">
    <textarea id="sel-text" rows="10"></textarea>
    <br/>
    <button type="button" id="download-txt">下載 閱讀名單</button>
  </form>

  <script>
  (async function(){
    // --- ICS 區塊 ---
    try {
      let res = await fetch('roster.ics');
      if (!res.ok) throw new Error('讀取 roster.ics 失敗：'+res.status);
      let icsText = await res.text();

      let jcal = ICAL.parse(icsText);
      let comp = new ICAL.Component(jcal);
      let vevents = comp.getAllSubcomponents('vevent');
      let tbody = document.getElementById('events-tbody');

      vevents.forEach((ve, i) => {
        let event = new ICAL.Event(ve);
        let dt = event.startDate.toString().slice(0,16);
        let summary = event.summary || '';
        let location = event.location || '';

        let tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${i+1}</td>
          <td><input data-idx="${i}" class="field-dt" type="datetime-local" value="${dt}" /></td>
          <td><input data-idx="${i}" class="field-sum" type="text" value="${summary}" /></td>
          <td><input data-idx="${i}" class="field-loc" type="text" value="${location}" /></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('status-ics').style.display='none';
      document.getElementById('editor-ics').style.display='block';

      document.getElementById('download-ics').onclick = () => {
        document.querySelectorAll('input.field-dt').forEach(input => {
          let idx = +input.dataset.idx;
          let ve = vevents[idx];
          let d = new Date(input.value);
          let icalDt = new ICAL.Time({
            year:   d.getUTCFullYear(),
            month:  d.getUTCMonth()+1,
            day:    d.getUTCDate(),
            hour:   d.getUTCHours(),
            minute: d.getUTCMinutes(),
            isDate: false
          });
          ve.getFirstProperty('dtstart').setValue(icalDt);
        });
        document.querySelectorAll('input.field-sum').forEach(input => {
          let idx = +input.dataset.idx;
          vevents[idx].getFirstProperty('summary').setValue(input.value);
        });
        document.querySelectorAll('input.field-loc').forEach(input => {
          let idx = +input.dataset.idx;
          vevents[idx].getFirstProperty('location').setValue(input.value);
        });

        let newIcs = comp.toString();
        let blob = new Blob([newIcs], { type: 'text/calendar;charset=utf-8' });
        let a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'roster-updated.ics';
        a.click();
        URL.revokeObjectURL(a.href);
      };

    } catch(e) {
      document.getElementById('status-ics').textContent = e;
    }

    // --- 文字檔 (selection.txt) 區塊 ---
    try {
      let res2 = await fetch('selection.txt');
      if (!res2.ok) throw new Error('讀取 selection.txt 失敗：'+res2.status);
      let txt = await res2.text();

      document.getElementById('sel-text').value = txt;
      document.getElementById('status-txt').style.display='none';
      document.getElementById('editor-txt').style.display='block';

      document.getElementById('download-txt').onclick = () => {
        let newText = document.getElementById('sel-text').value;
        let blob2 = new Blob([newText], { type: 'text/plain;charset=utf-8' });
        let a2 = document.createElement('a');
        a2.href = URL.createObjectURL(blob2);
        a2.download = 'selection-updated.txt';
        a2.click();
        URL.revokeObjectURL(a2.href);
      };

    } catch(e) {
      document.getElementById('status-txt').textContent = e;
    }

  })();
  </script>
</body>
</html>
