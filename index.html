<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>排班與名單靜態編輯器</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: 2em auto;
      padding: 0 1em;
    }
    h1, h2 {
      margin-top: 1.5em;
    }
    .status {
      color: #666;
      margin: 0.5em 0;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5em;
      text-align: left;
    }
    th {
      background: #f5f5f5;
    }
    input[type="datetime-local"],
    input[type="text"],
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 1em;
      padding: 0.3em;
    }
    textarea {
      height: 200px;
      resize: vertical;
    }
    button {
      font-size: 1em;
      padding: 0.5em 1em;
      margin: 0.5em 0;
    }
    .btn-group {
      margin-top: 0.5em;
    }
    .center {
      text-align: center;
    }
  </style>
  <!-- 載入 ical.js -->
  <script src="https://cdn.jsdelivr.net/npm/ical.js@1.4.0/build/ical.min.js"></script>
</head>
<body>
  <h1>排班（ICS）靜態編輯器</h1>
  <div id="status-ics" class="status">正在載入 roster.ics …</div>
  <div id="editor-ics" style="display:none">
    <table>
      <thead>
        <tr>
          <th class="center">#</th>
          <th>開始時間 (UTC)</th>
          <th>事件名稱 (SUMMARY)</th>
          <th>地點 (LOCATION)</th>
        </tr>
      </thead>
      <tbody id="events-tbody"></tbody>
    </table>
    <div class="btn-group">
      <button id="download-ics">下載 更新後 roster.ics</button>
    </div>
  </div>

  <h2>同事名單（selection.txt）靜態編輯器</h2>
  <div id="status-txt" class="status">正在載入 selection.txt …</div>
  <div id="editor-txt" style="display:none">
    <textarea id="sel-text"></textarea>
    <div class="btn-group">
      <button id="download-txt">下載 更新後 selection.txt</button>
    </div>
  </div>

  <script>
  (async function(){
    // 全域變數
    let comp, vevents;

    // --- ICS 區塊 ---
    try {
      const resIcs = await fetch('roster.ics');
      if (!resIcs.ok) throw new Error(resIcs.status + ' ' + resIcs.statusText);
      const icsText = await resIcs.text();

      // 解析 ICS
      const jcal = ICAL.parse(icsText);
      comp = new ICAL.Component(jcal);
      vevents = comp.getAllSubcomponents('vevent');

      const tbody = document.getElementById('events-tbody');

      vevents.forEach((ve, i) => {
        const event = new ICAL.Event(ve);
        const jsDate = event.startDate.toJSDate();
        // datetime-local 的 value 要 "YYYY-MM-DDThh:mm"
        const dtLocal = jsDate.toISOString().slice(0,16);
        const summary = event.summary || '';
        const location = event.location || '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="center">${i+1}</td>
          <td>
            <input type="datetime-local" data-idx="${i}" value="${dtLocal}">
          </td>
          <td>
            <input type="text" data-idx="${i}" class="field-sum" value="${summary}">
          </td>
          <td>
            <input type="text" data-idx="${i}" class="field-loc" value="${location}">
          </td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('status-ics').style.display = 'none';
      document.getElementById('editor-ics').style.display = 'block';

      // 下載更新後的 roster.ics
      document.getElementById('download-ics').onclick = () => {
        // 先把表格值寫回每個 vevent
        document.querySelectorAll('input[type="datetime-local"]').forEach(input => {
          const idx = +input.dataset.idx;
          const ve = vevents[idx];
          const d = new Date(input.value);
          const t = new ICAL.Time({
            year:   d.getUTCFullYear(),
            month:  d.getUTCMonth()+1,
            day:    d.getUTCDate(),
            hour:   d.getUTCHours(),
            minute: d.getUTCMinutes(),
            second: d.getUTCSeconds(),
            isDate: false
          });
          ve.getFirstProperty('dtstart').setValue(t);
        });
        document.querySelectorAll('input.field-sum').forEach(input => {
          const idx = +input.dataset.idx;
          vevents[idx].getFirstProperty('summary').setValue(input.value);
        });
        document.querySelectorAll('input.field-loc').forEach(input => {
          const idx = +input.dataset.idx;
          vevents[idx].getFirstProperty('location').setValue(input.value);
        });

        const newIcs = comp.toString();
        const blob = new Blob([newIcs], { type: 'text/calendar;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'roster-updated.ics';
        a.click();
        URL.revokeObjectURL(a.href);
      };

    } catch(err) {
      document.getElementById('status-ics').textContent =
        '載入 roster.ics 失敗：' + err;
    }

    // --- selection.txt 區塊 ---
    try {
      const resTxt = await fetch('selection.txt');
      if (!resTxt.ok) throw new Error(resTxt.status + ' ' + resTxt.statusText);
      const txt = await resTxt.text();

      const ta = document.getElementById('sel-text');
      ta.value = txt;

      document.getElementById('status-txt').style.display = 'none';
      document.getElementById('editor-txt').style.display = 'block';

      document.getElementById('download-txt').onclick = () => {
        const newText = ta.value;
        const blob = new Blob([newText], { type: 'text/plain;charset=utf-8' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'selection-updated.txt';
        a.click();
        URL.revokeObjectURL(a.href);
      };

    } catch(err) {
      document.getElementById('status-txt').textContent =
        '載入 selection.txt 失敗：' + err;
    }
  })();
  </script>
</body>
</html>
