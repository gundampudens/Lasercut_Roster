<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>排班編輯頁面</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family:sans-serif; max-width:800px; margin:1em auto; }
    textarea { width:100%; height:400px; font-family:monospace; box-sizing:border-box; }
    button { padding:0.5em 1em; margin-top:0.5em; }
    #status { margin-top:0.5em; color:red; }
  </style>
</head>
<body>
  <h1>排班編輯頁面</h1>
  <div id="status">載入中…</div>
  <textarea id="editor" disabled></textarea>
  <br>
  <button id="saveBtn" disabled>送出並 Commit 到 GitHub</button>

  <script>
  (()=>{
    const status = document.getElementById('status');
    const editor = document.getElementById('editor');
    const saveBtn = document.getElementById('saveBtn');
    let currentSha = '';

    // 1. 讀取現有 Roster.txt
async function loadRoster(){
  try {
    const r = await fetch('/api/roster');
    const txt = await r.text();             // 先拿純文字
    if (!r.ok) throw new Error(txt);        // HTTP 400+ 也 throw
    // 嘗試 parse JSON
    let j;
    try { j = JSON.parse(txt); }
    catch(e) { throw new Error('不是 JSON，原始回傳：\n' + txt); }
    editor.value = j.text;
    currentSha = j.sha;
    status.textContent = '載入完畢';
    editor.disabled = false;
    saveBtn.disabled = false;
  } catch(err) {
    status.textContent = '讀取失敗：' + err.message;
  }
}

    // 2. 提交修改
    saveBtn.addEventListener('click', async ()=>{
      saveBtn.disabled = true;
      status.textContent = '送出中…';
      try {
        const payload = {
          content: editor.value,
          sha: currentSha
        };
        const r = await fetch('/api/update', {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if (!r.ok) throw j;
        currentSha = j.content.sha;
        status.textContent = 'Commit 成功！GitHub SHA: ' + currentSha;
        status.style.color = 'green';
      } catch(err) {
        status.textContent = 'Commit 失敗：' + (err.message||JSON.stringify(err));
        status.style.color = 'red';
      } finally {
        saveBtn.disabled = false;
      }
    });

    loadRoster();
  })();
  </script>
</body>
</html>

